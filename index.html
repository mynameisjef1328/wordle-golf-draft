<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wordle Golf Scorecard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #999; color: white; }
    .under-par { background-color: lightgreen; }
    .over-par  { background-color: lightcoral; }
    .even-par  { background-color: white; }
    input[type="number"] { width: 50px; text-align: center; display: inline-block; vertical-align: middle; }
    input[type="text"] { width: 100px; }
  </style>
</head>
<body>
  <h2>Wordle Golf Scorecard</h2>

  <label for="courseSelect">Choose a course:</label>
  <select id="courseSelect"></select>
  <button id="clearBtn" style="margin-left:12px;">Clear Scores</button>

  <table id="scorecard">
    <thead>
      <tr>
        <th>Player</th>
        <th colspan="18">Hole</th>
        <th>Total</th>
        <th>+/-</th>
      </tr>
      <tr>
        <th></th>
        <script>
          for (let i = 1; i <= 18; i++) document.write(`<th>${i}</th>`);
        </script>
        <th>Par</th>
        <th></th>
      </tr>
      <tr id="parRow"><th>Par</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- MOVE THE SCRIPT OUTSIDE TBODY -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC9-Z6E59grKoq_pD8acGTre2Jx-1NQ_Qc",
    authDomain: "wordle-golf-6c636.firebaseapp.com",
    projectId: "wordle-golf-6c636",
    storageBucket: "wordle-golf-6c636.appspot.com",
    messagingSenderId: "672104265687",
    appId: "1:672104265687:web:2c16b0539fcd52ca4d7d92"
  };

  let app, db;
(async () => {
  try {
    app = initializeApp(firebaseConfig);
    db  = getFirestore(app);
    console.log("Firebase OK:", firebaseConfig.projectId);

    // optional quick ping
    await setDoc(doc(db, "diagnostics", "ping"),
      { ok: true, ts: Date.now() }, { merge: true });
    console.log("Ping wrote");
  } catch (e) {
    console.error("Firebase init/ping error:", e);
  }
})();

    async function testWriteCourse(course = "Bully Pulpit") {
  try {
    await setDoc(doc(db, "wordleScorecards", course), {
      course,
      players: [
        { name: "Tester 1", scores: ["3","4","","","","","","","","","","","","","","","",""] },
        { name: "Tester 2", scores: [] },
        { name: "Player 3", scores: [] },
        { name: "Player 4", scores: [] }
      ],
      updatedAt: serverTimestamp()
    }, { merge: true });
    console.log("testWriteCourse OK");
  } catch (e) {
    console.error("testWriteCourse error:", e);
  }
}

testWriteCourse(); // runs once on load

  // ...keep the rest of your scorecard code here (courses, updateParRow, buildPlayerRow, saveScoresToFirestore, etc.)

    // ---------- Data ----------
    const courses = {
      'Pebble Beach': [4,4,3,4,5,4,4,3,5,4,3,4,5,4,4,3,4,5],
      'St. Andrews':  [4,5,4,3,4,4,5,3,4,4,3,5,4,4,3,4,5,4],
      'Augusta':      [5,4,3,4,5,3,4,4,4,3,5,4,4,3,4,5,4,3],
      'Pine Valley':  [4,3,5,4,4,3,4,5,4,4,3,4,4,5,3,4,5,4],
      'Torrey Pines': [4,4,5,3,4,5,4,3,4,4,4,5,3,4,4,5,3,4],
      'TPC Sawgrass': [4,4,3,5,4,3,4,5,4,3,4,5,4,4,3,5,4,3],
      'Bethpage Black': [4,5,3,4,4,5,4,4,3,4,5,3,4,4,5,3,4,4],
      'Whistling Straits': [4,3,5,4,4,5,3,4,4,5,4,3,4,4,5,4,3,4],
      'Kiawah Island': [4,4,5,3,4,3,4,5,4,4,4,5,3,4,4,5,3,4],
      'Bully Pulpit': [3,4,5,4,3,5,4,4,4,5,4,3,4,5,4,4,3,4]
    };

    const parRow        = document.getElementById('parRow');
    const courseSelect  = document.getElementById('courseSelect');
    const tbody         = document.querySelector('#scorecard tbody');

    // Populate course dropdown
    Object.keys(courses).forEach(course => {
      const option = document.createElement('option');
      option.value = course;
      option.textContent = course;
      courseSelect.appendChild(option);
    });

    let currentPar = [];
    let unsubscribe = null;
    let applyingRemote = false;

    function updateParRow(parValues) {
      parRow.innerHTML = '';
      parRow.innerHTML += '<th></th>';
      parValues.forEach(par => {
        const th = document.createElement('th');
        th.textContent = par;
        parRow.appendChild(th);
      });
      const parTotal = parValues.reduce((sum, p) => sum + p, 0);
      parRow.innerHTML += `<th>${parTotal}</th>`;
      parRow.innerHTML += '<th></th>';
    }

    function buildPlayerRow(name = '', rowIndex = 0, savedScores = []) {
      const row = document.createElement('tr');

      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name;
      nameInput.addEventListener('input', () => saveScoresToFirestore());
      nameCell.appendChild(nameInput);
      row.appendChild(nameCell);

      for (let i = 0; i < 18; i++) {
        const cell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 1;
        input.value = savedScores[i] || '';
        input.addEventListener('input', () => {
          calculate(row);
          saveScoresToFirestore();
        });
        cell.appendChild(input);
        row.appendChild(cell);
      }

      const totalCell = document.createElement('td');
      totalCell.className = 'total';
      totalCell.textContent = '0';
      row.appendChild(totalCell);

      const diffCell = document.createElement('td');
      diffCell.className = 'diff';
      diffCell.textContent = '0';
      row.appendChild(diffCell);

      setTimeout(() => calculate(row), 0);
      return row;
    }

    function calculate(row) {
      const inputs = row.querySelectorAll('input[type="number"]');
      let total = 0;
      let parTotal = 0;

      inputs.forEach((input, index) => {
        const val = parseInt(input.value);
        const par = currentPar[index];
        const cell = input.parentElement;
        cell.className = '';
        if (!isNaN(val)) {
          total += val;
          parTotal += par;
          if (val < par) cell.className = 'under-par';
          else if (val > par) cell.className = 'over-par';
          else cell.className = 'even-par';
        }
      });

      row.querySelector('.total').textContent = total || '0';
      const diff = total - parTotal;
      row.querySelector('.diff').textContent = total ? (diff > 0 ? `+${diff}` : `${diff}`) : '0';
    }

    // ---------- Firestore helpers ----------
    const buildDefaultPlayers = () =>
      Array.from({ length: 4 }, (_, i) => ({ name: `Player ${i + 1}`, scores: [] }));

    function readTableData() {
      const data = { course: courseSelect.value, players: [] };
      tbody.querySelectorAll('tr').forEach(row => {
        const name = row.querySelector('input[type="text"]')?.value || '';
        const scores = Array.from(row.querySelectorAll('input[type="number"]')).map(i => i.value);
        data.players.push({ name, scores });
      });
      return data;
    }

    async function saveScoresToFirestore() {
      if (applyingRemote || !db) return;
      const data = readTableData();
      const ref = doc(db, 'wordleScorecards', data.course);
      await setDoc(ref, { course: data.course, players: data.players, updatedAt: serverTimestamp() }, { merge: true });
    }

    function sameData(a, b) {
      try { return JSON.stringify(a) === JSON.stringify(b); } catch { return false; }
    }

    function renderFromData(docData) {
      tbody.innerHTML = '';
      const players = docData?.players?.length ? docData.players : buildDefaultPlayers();
      players.forEach((p, i) => tbody.appendChild(buildPlayerRow(p.name, i, p.scores || [])));
    }

    async function ensureDocExists(courseName) {
      if (!db) return;
      const ref = doc(db, 'wordleScorecards', courseName);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { course: courseName, players: buildDefaultPlayers(), updatedAt: serverTimestamp() });
      }
    }

    async function attachListenerForCourse(courseName) {
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      if (!db) return; // offline or config missing

      await ensureDocExists(courseName);
      const ref = doc(db, 'wordleScorecards', courseName);

      unsubscribe = onSnapshot(ref, snap => {
        if (!snap.exists()) return;
        const serverData = snap.data();
        const localData = readTableData();

        if (!sameData(
          { course: localData.course, players: localData.players },
          { course: serverData.course, players: serverData.players }
        )) {
          applyingRemote = true;
          currentPar = courses[courseName];
          updateParRow(currentPar);
          renderFromData(serverData);
          applyingRemote = false;
        }
      });
    }

    async function loadScorecard(courseName) {
      currentPar = courses[courseName];
      updateParRow(currentPar);

      // Render something immediately so the table never looks empty
      renderFromData({ players: buildDefaultPlayers() });

      // Then attach realtime sync
      await attachListenerForCourse(courseName);
    }

    // ---------- Boot ----------
    const last = localStorage.getItem('lastCourse');
    courseSelect.value = last && courses[last] ? last : Object.keys(courses)[0];
    loadScorecard(courseSelect.value);

    courseSelect.addEventListener('change', e => {
      localStorage.setItem('lastCourse', e.target.value);
      loadScorecard(e.target.value);
    });

// ---------- Clear Scores Button ----------
document.getElementById('clearBtn').addEventListener('click', async () => {
  if (!confirm("Clear all player scores for this course?")) return;

  const playersCleared = Array.from(tbody.querySelectorAll('tr')).map((row, i) => {
    const name = row.querySelector('input[type="text"]')?.value || `Player ${i+1}`;
    return { name, scores: [] };
  });

  // Update the table immediately
  renderFromData({ players: playersCleared });
  updateParRow(currentPar);

  // Push to Firestore
  try {
    const ref = doc(db, 'wordleScorecards', courseSelect.value);
    await setDoc(ref, {
      course: courseSelect.value,
      players: playersCleared,
      updatedAt: serverTimestamp()
    }, { merge: true });
    console.log("Scores cleared");
  } catch (err) {
    console.error("Clear scores failed:", err);
    alert("Clear failed. Check console.");
  }
});
    
  </script>
</body>
</html>
